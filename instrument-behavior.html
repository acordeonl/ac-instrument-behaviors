<link rel="import" href="../polymer/polymer.html">

<script>
/**
* Behavior that highlights stuff.
*
* @polymerBehavior
*/
    InstrumentBehavior= {
        listeners:{
            'notes-loaded':'_onNotesLoaded',
            'action': '_action'
        },
        properties:{
            finishedLoading:{
                type:Boolean,
                value:false
            },
            playing:{
                type:Boolean,
                value:false
            },
            rotation: {
                type: Boolean,
                value: false
            },
            recording: {
                type: Boolean,
                value: false
            }
        },
        // ------------- instrument loading ---------------------
        _onNotesLoaded: function(){
            var flag = true ;
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++)
                flag &= nodeList[i].finishedLoading;
            if(flag){
                this.finishedLoading = true ;
                this.async(function(){
                    for (var j = 0; j < nodeList.length; j++)
                        nodeList[j].onFinishedLoadingNotes();
                } , 0 )  ;
                if(this.playing)
                    this.$$('AC-PLAYER').play() ;
            }
        },
        // ------------- midi ---------------------
        _action: function (e) {
            if(!this.finishedLoading)
                return  ;
            if (this.recording && e.detail.fromPlayer === undefined && e.detail.channel !== 2)
                this.$$('AC-RECORDER').addInstrumentActivity(e.detail.cmd, e.detail.midiNote, e.detail.channel);
            if (e.detail.cmd==='velocity-change') {
                this._setVelocity (e.detail.velocity) ;
            }
            this._instrumentAction(e) ;
        },
        _setVelocity: function(velocity){
            noteNotFound = false ;
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].setVelocity(velocity/127) ;
            }
        },
        // ------------- GUI update ---------------------
        _loop: function () {
            this._update();
            window.requestAnimationFrame(this._loop.bind(this));
        },
        _update: function(){
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].update() ;
            }
            this.$$('AC-PLAYER').scheduleNotes();
        },
        // ------------- recording controls -------------
        startRecording: function () {
            this.recording = true;
            this.$$('AC-RECORDER').startRecording();
        },
        pauseRecording: function () {
            this.recording = false;
            this.$$('AC-RECORDER').saveRecording();
        },
        // ------------- playback controls --------------
        play: function () {
            this.playing = true ;
            this.$$('AC-PLAYER').play();
        },
        pause: function () {
            this.playing = false;
            this.$$('AC-PLAYER').pause();
            this._stopAudio('playbackWithGUI') ;
        },
        _stopAudio: function(origin){
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].stopAudio(origin) ;
            }
        },
        setTempo: function(e){
            if(this.playing)
                this.$$('AC-PLAYER').pause() ;
            this._stopAudio('playbackWithGUI') ;
            this.async(function(){
                this.$$('AC-PLAYER').setTempo(e.detail.tempo) ;
            } , 0 )  ;
            if(this.playing){
                this.async(function(){
                    this.$$('AC-PLAYER').play() ;
                } , 100 )  ;
            }
        },
        // ------------- settings controls --------------
        _reportInstruments: function(){
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].reportInstrument() ;
            }
        },
        addPitch: function (diff) {
            if(this.playing){
                this.$$('AC-PLAYER').pause() ;
                this._stopAudio('playback') ;
            }
            else {
                this._stopAudio('playbackWithGUI') ;
            }
            this._stopAudio('instrument') ;
            this.finishedLoading = false ;
            noteNotFound = false ;
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].addPitch(diff) ;
            }
        },
        toggleNotes: function (which,value) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].toggleNotesOnButtons(which,value) ;
            }
        },
        setOpacity: function(which,opacity){
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].setOpacity(which,opacity/100) ;
            }
        },
        setReverb: function(value){
            synthReverb = value ;
            wet.gain.value = ( 1.0 - ((100-synthReverb)/100) );
            dry.gain.value = (100-synthReverb)/100;
        },
        setVolume: function (e) {
            if(e.detail.origin==='instrument') {
                this.$$('[name='+e.detail.instrumentName+']').instrumentVolume = e.detail.volume/100 ;
            }
            else{
                this.$$('[name='+e.detail.instrumentName+']').playbackVolume = e.detail.volume/100 ;
            }
        },
        setPanning: function(e){
            if(e.detail.origin==='instrument') {
                this.$$('[name='+e.detail.instrumentName+']').instrumentPanning = e.detail.panning/100 ;
            }
            else{
                this.$$('[name='+e.detail.instrumentName+']').playbackPanning = e.detail.panning/100 ;
            }
        },
        setRotation: function (e) {
            this.rotation = e.detail.rotation ;
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].rotation = e.detail.rotation ;
            }
        },
        ready: function () {
            Polymer.RenderStatus.afterNextRender(this, function(){
                this._loop();
                this._reportInstruments() ;

                // for testing
                this.addPitch(0) ;
            }) ;
        }
    } ;
</script>
