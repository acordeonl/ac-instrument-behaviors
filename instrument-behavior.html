<link rel="import" href="../polymer/polymer.html">

<script>
/**
* Behavior that highlights stuff.
*
* @polymerBehavior
*/
    InstrumentBehavior= {
        listeners:{
            'action': '_action'
        },
        properties:{
            recording: {
                type: Boolean,
                value: false
            },
        },

        // ------------- midi ---------------------
        _action: function (e) {
            if (this.recording && e.detail.fromPlayer === undefined && e.detail.channel !== 2)
                this.$$('AC-RECORDER').addInstrumentActivity(e.detail.cmd, e.detail.midiNote, e.detail.channel);
            if (e.detail.cmd==='velocity-change') {
                this._setVelocity (e.detail.velocity) ;
            }
            this._instrumentAction(e) ;
        },
        _setVelocity: function(velocity){
            noteNotFound = false ;
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].setVelocity(velocity) ;
            }
        },
        // ------------- GUI update ---------------------
        _loop: function () {
            this._update();
            window.requestAnimationFrame(this._loop.bind(this));
        },
        _update: function(){
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].update() ;
            }
            this.$$('AC-PLAYER').scheduleNotes();
        },
        // ------------- recording controls -------------
        startRecording: function () {
            this.recording = true;
            this.$$('AC-RECORDER').startRecording();
        },
        pauseRecording: function () {
            this.recording = false;
            this.$$('AC-RECORDER').saveRecording();
        },
        // ------------- playback controls --------------
        play: function () {
            this.$$('AC-PLAYER').play();
        },
        pause: function () {
            this.$$('AC-PLAYER').pause();
        },
        // ------------- settings controls --------------
        _reportInstruments: function(){
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].reportInstrument() ;
            }
        },
        changePitch: function (diff) {
            noteNotFound = false ;
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].changePitch(diff) ;
            }
        },
        toggleNotes: function (which) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].toggleNotesOnButtons(which) ;
            }
        },
        setOpacity: function(which,opacity){
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].setOpacity(which,opacity) ;
            }
        },
        setReverb: function(value){
            synthReverb = value ;
            wet.gain.value = ( 1.0 - ((100-synthReverb)/100) );
            dry.gain.value = (100-synthReverb)/100;
        },
        changeVolume: function (e) {
            if(e.detail.origin==='instrument') {
                this.$$('[name='+e.detail.instrumentName+']').setInstrumentVolume(e.detail.volume) ;
            }
            else{
                this.$$('[name='+e.detail.instrumentName+']').setPlaybackVolume(e.detail.volume) ;
            }
        },
        setPanning: function(e){
            if(e.detail.origin==='instrument') {
                this.$$('[name='+e.detail.instrumentName+']').setInstrumentPanning(e.detail.panning) ;

            }
            else{
                this.$$('[name='+e.detail.instrumentName+']').setPlaybackPanning(e.detail.panning) ;
            }
        },
        ready: function () {
            Polymer.RenderStatus.afterNextRender(this, function () {
                this._loop();
                this._reportInstruments() ;
            });
        }
    } ;
</script>
