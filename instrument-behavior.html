<link rel="import" href="../polymer/polymer.html">

<script>
/**
* Behavior that highlights stuff.
*
* @polymerBehavior
*/
    InstrumentBehavior= {
        listeners:{
            'action': '_action'
        },
        properties:{
            recording: {
                type: Boolean,
                value: false
            },
            velocity: {
                type: Number,
                value: 1
            },
            volumes: {
                type: Array,
                value: []
            },
            tone: {
                type: Number,
                value: 0
            },
        },
        _action: function (e) {
            if (this.recording && e.detail.fromPlayer === undefined && e.detail.channel !== 2)
                this.$$('AC-RECORDER').addInstrumentActivity(e.detail.cmd, e.detail.midiNote, e.detail.channel);
            if (e.detail.cmd==='velocity-change') {
                this.velocity = (e.detail.velocity/127) ;
            }
            this._instrumentAction(e) ;
        },
        changeVolume: function (e) {
            if(e.detail.origin==='instrument') {
                this.$$('[name='+e.detail.instrumentName+']').instrumentVolume = e.detail.volume/100 ;
            }
            else{
                this.$$('[name='+e.detail.instrumentName+']').playbackVolume = e.detail.volume/100 ;
            }
        },
        // ------------- GUI update ---------------------
        _loop: function () {
            this._update();
            window.requestAnimationFrame(this._loop.bind(this));
        },
        _update: function(){
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].update() ;
            }
            this.$$('AC-PLAYER').scheduleNotes();
        },
        // ------------- recording controls -------------
        startRecording: function () {
            this.recording = true;
            this.$$('AC-RECORDER').startRecording();
        },
        pauseRecording: function () {
            this.recording = false;
            this.$$('AC-RECORDER').saveRecording();
        },
        // ------------- playback controls --------------
        play: function () {
            this.$$('AC-PLAYER').play();
        },
        pause: function () {
            this.$$('AC-PLAYER').pause();
        },
        changePitch: function (diff) {
            noteNotFound = false ;
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].changePitch(diff) ;
            }
        },
        toggleNotes: function (which) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].toggleNotesOnButtons(which) ;
            }
        },
        _reportInstruments: function(){
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].reportInstrument() ;
            }
        },
        ready: function () {
            Polymer.RenderStatus.afterNextRender(this, function () {
                this._loop();
                this._reportInstruments() ;
            });
        }
    } ;
</script>
