<link rel="import" href="../polymer/polymer.html">

<script>
/**
* Behavior that highlights stuff.
*
* @polymerBehavior
*/
    InstrumentBehavior= {
        listeners:{
            'notes-loaded':'_instrumentLoaded',
            'action': '_action'
        },
        properties:{
            synthesizersLoaded:{
                type:Number,
                value:0
            },
            isReady:{
                type:Boolean,
                value:false
            },
            finishedLoading:{
                type:Boolean,
                value:false
            },
            playing:{
                type:Boolean,
                value:false
            },
            rotation: {
                type: Boolean,
                value: false
            },
            recording: {
                type: Boolean,
                value: false
            }
        },
        // ------------- instrument loading ---------------------
        _instrumentLoaded: function(){
            if(this.synthesizersLoaded===undefined)
                this.synthesizersLoaded = 0 ;
            this.synthesizersLoaded++ ;
            if(this.isReady === undefined || this.isReady === false)
                return ;
            if (this.synthesizersLoaded === this.synthesizers) {
                this.finishedLoading = true ;
                this._reportInstruments() ;
                this._onFinishedLoadingNotes() ;
            }
        },
        _onNotesLoaded: function(){
            var flag = true ;
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++)
                flag &= nodeList[i].finishedLoading;
            if(flag){
                this.finishedLoading = true ;
                this.async(function(){
                    for (var j = 0; j < nodeList.length; j++)
                        nodeList[j].onFinishedLoadingNotes();
                } , 0 )  ;
                if(this.playing)
                    this.$$('AC-PLAYER').play() ;
            }
        },
        // ------------- midi ---------------------
        _action: function (e) {
            if(!this.finishedLoading)
                return  ;
            if (this.recording && e.detail.fromPlayer === undefined && e.detail.channel !== 2)
                this.$$('AC-RECORDER').addInstrumentActivity(e.detail.cmd, e.detail.button, e.detail.channel);
            if (e.detail.cmd==='velocity-change') {
                this._setVelocity (e.detail.velocity) ;
            }
            this._instrumentAction(e) ;
        },
        _setVelocity: function(velocity){
            noteNotFound = false ;
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].setVelocity(velocity/127) ;
            }
        },
        // ------------- GUI update ---------------------
        update: function(){
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].update() ;
            }
            this.$$('AC-PLAYER').scheduleNotes();
        },
        // ------------- recording controls -------------
        startRecording: function () {
            this.recording = true;
            this.$$('AC-RECORDER').startRecording();
        },
        pauseRecording: function () {
            this.recording = false;
            this.$$('AC-RECORDER').saveRecording();
        },
        // ------------- playback controls --------------
        play: function () {
            this.playing = true ;
            this.$$('AC-PLAYER').play();
        },
        pause: function () {
            this.playing = false;
            this.$$('AC-PLAYER').pause();
            this._stopAudio('playback') ;
            this._resetGUI('playback',false ) ;
        },
        setProgress: function(progress){
            this._resetGUI('playback',true) ;
            this.$$('AC-PLAYER').setProgress(progress);
            this._showCurrentGUIState() ;
        },
        _stopAudio: function(origin){
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].stopAudio(origin) ;
            }
        },
        _resetGUI: function(origin,clearState){
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].resetGUI(origin,clearState) ;
            }
        },
        _showCurrentGUIState: function(){
            this.$$('AC-PLAYER').showCurrentGUIState() ;
        },
        setTempo: function(e){
            this.$$('AC-PLAYER').setTempo(e.detail.tempo) ;
        },
        // ------------- settings controls --------------
        _reportInstruments: function(){
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].reportInstrument() ;
            }
        },
        addPitch: function (diff) {
            if(this.playing)
                this.$$('AC-PLAYER').pause() ;
            this._stopAudio('playback') ;
            this._stopAudio('instrument') ;
            this._resetGUI('playback',false ) ;
            this._resetGUI('instrument',true ) ;
            this.finishedLoading = false ;
            noteNotFound = false ;
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].addPitch(diff) ;
            }
        },
        toggleNotes: function (which,value) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].toggleNotesOnButtons(which,value) ;
            }
        },
        setOpacity: function(which,opacity){
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].setOpacity(which,opacity/100) ;
            }
        },
        setReverb: function(value){
            synthReverb = value ;
            wet.gain.value = ( 1.0 - ((100-synthReverb)/100) );
            dry.gain.value = (100-synthReverb)/100;
        },
        setVolume: function (e) {
            if(e.detail.origin==='instrument') {
                this.$$('[name='+e.detail.instrumentName+']').instrumentVolume = e.detail.volume/100 ;
            }
            else{
                this.$$('[name='+e.detail.instrumentName+']').playbackVolume = e.detail.volume/100 ;
            }
        },
        setPanning: function(e){
            if(e.detail.origin==='instrument') {
                this.$$('[name='+e.detail.instrumentName+']').instrumentPanning = e.detail.panning/100 ;
            }
            else{
                this.$$('[name='+e.detail.instrumentName+']').playbackPanning = e.detail.panning/100 ;
            }
        },
        setRotation: function (e) {
            this.rotation = e.detail.rotation ;
            var nodeList = Polymer.dom(this.root).querySelectorAll('[buttons]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].rotation = e.detail.rotation ;
            }
        },
        ready: function () {
            this.isReady = true ;
            if (this.synthesizersLoaded === this.synthesizers) {
                this._reportInstruments() ;
            }
        }
    } ;
</script>
